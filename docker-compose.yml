# =============================================================================
# SUT Smart Bus - Docker Compose (Optimized for Windows Server 2022)
# =============================================================================
# Usage:
#   docker-compose up -d        # Start all services
#   docker-compose down         # Stop all services
#   docker-compose logs -f      # View logs
#   docker-compose ps           # Check status
#   docker-compose down -v      # Stop and remove volumes (CAUTION: deletes data)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MongoDB Database
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0
    container_name: sut-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=sut_smart_bus
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    # Resource limits (adjust based on server capacity)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ---------------------------------------------------------------------------
  # Mosquitto MQTT Broker
  # ---------------------------------------------------------------------------
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: sut-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # WebSocket
    volumes:
      - ./docker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # ---------------------------------------------------------------------------
  # SUT Smart Bus API Server
  # ---------------------------------------------------------------------------
  server:
    build:
      context: .
      dockerfile: Dockerfile
    image: sut-smart-bus-server:latest
    container_name: sut-server
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
      - MONGODB_URL=mongodb://mongodb:27017/sut_smart_bus
      - TZ=Asia/Bangkok
      # Production settings (uncomment and configure):
      # - API_SECRET_KEY=your-secret-key-here
      # - CORS_ORIGINS=https://your-app-domain.com
    volumes:
      - ./firmware:/app/firmware
      - ./routes:/app/routes
      - ./app:/app/app
      - server_data:/app/data
    depends_on:
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

# =============================================================================
# Volumes for Data Persistence
# =============================================================================
volumes:
  mongodb_data:
    name: sut_mongodb_data
  mosquitto_data:
    name: sut_mosquitto_data
  mosquitto_logs:
    name: sut_mosquitto_logs
  server_data:
    name: sut_server_data

# =============================================================================
# Networks (optional - for better isolation)
# =============================================================================
networks:
  default:
    name: sut_network
    driver: bridge
